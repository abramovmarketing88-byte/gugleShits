# Итоговая инструкция: что куда залить, чтобы всё работало

## 1. Где всё крутится

Проект — **Google Apps Script**, привязанный к **одной Google Таблице**.  
Листы: INPUT, OUT, SETTINGS, LOG. Лист CONTROL создаётся скриптом сам при первом открытии меню.

---

## 2. Что куда добавить в редакторе Apps Script

Откройте таблицу → **Расширения** → **Apps Script**.  
В проекте должны быть **5 файлов**. Создавайте или переименовывайте файлы так:

| В редакторе Apps Script | Откуда брать код |
|-------------------------|------------------|
| **main.gs**             | Скопировать весь файл `main.gs` из репозитория |
| **utils.gs**            | Скопировать весь файл `utils.gs` из репозитория |
| **prompts.gs**          | Скопировать весь файл `prompts.gs` из репозитория |
| **openrouter.gs**       | Скопировать весь файл `openrouter.gs` из репозитория |
| **CopyHtmlDialog.html** | Скопировать весь файл `CopyHtmlDialog.html` из репозитория |

### Как добавить HTML-файл

- В Apps Script: **+** (добавить файл) → **HTML**.
- Имя файла задайте **ровно**: `CopyHtmlDialog.html` (без лишних пробелов).
- Вставьте содержимое из репозитория и сохраните.

Имена `.gs` файлов могут быть любыми (например `Main`, `Utils`), но **имя HTML-файла должно быть точно `CopyHtmlDialog`** — на него идёт ссылка в коде: `HtmlService.createTemplateFromFile('CopyHtmlDialog')`. Если переименуете HTML — поменяйте это имя в `main.gs` в функции `menuCopyHtmlModal`.

---

## 3. Листы в Google Таблице

Создайте вручную листы с такими именами (регистр важен):

| Лист      | Кто создаёт | Действие |
|-----------|-------------|----------|
| **INPUT** | Вы          | Создать лист с именем `INPUT` |
| **OUT**   | Вы          | Создать лист с именем `OUT` |
| **SETTINGS** | Вы       | Создать лист с именем `SETTINGS` |
| **LOG**   | Вы          | Создать лист с именем `LOG` |
| **CONTROL** | Скрипт    | Создаётся автоматически при первом открытии меню **Avito AI** |

### INPUT — первая строка (заголовки)

В первую строку листа **INPUT** впишите заголовки **в одну строку**, в колонки A–M:

```
id | product | city | source_text | tone | constraints | mode | status | last_error | updated_at | locked_at | locked_by | processing
```

Данные — со 2-й строки. Колонка **id** — уникальный идентификатор (число или текст). Для FULL/OFFER_ONLY обязательны: **product**, **city**, **source_text**. **mode**: FULL, OFFER_ONLY, SPIN_ONLY, HTML_ONLY. **status** можно оставить пустым или NEW — скрипт сам переведёт в QUEUED при запуске генерации.

### OUT — первая строка (заголовки)

В первую строку листа **OUT**:

```
id | offer_text | title_1 | title_2 | title_3 | spintax_text | avito_html | qa_checks | qa_status | qa_reasons | qa_fixed | model_used | tokens_est
```

Скрипт сам дополняет строки по **id** из INPUT; вручную можно ничего не заполнять.

### SETTINGS — две колонки: ключ и значение

Колонка A — ключ, колонка B — значение. Пример:

| A (key)              | B (value)                    |
|----------------------|------------------------------|
| OPENROUTER_API_KEY   | sk-or-v1-...                |
| MODEL_OFFER          | openai/gpt-4o                |
| MODEL_FORMAT         | openai/gpt-4o-mini           |
| MODEL_FALLBACK       | openai/gpt-4o-mini           |
| PROMPT_VERSION_OFFER | 1                            |
| PROMPT_VERSION_FORMAT | 1                            |
| BATCH_SIZE           | 50                           |
| MAX_RUNTIME_SECONDS  | 300                          |
| cache_ttl_hours      | 72                           |
| TEMPERATURE_OFFER    | 0.4                          |
| TEMPERATURE_FORMAT   | 0.5                          |
| AVITO_STYLE          | bold_emojis_safe             |
| LANGUAGE             | ru                           |

**OPENROUTER_API_KEY** обязателен (ключ с [openrouter.ai](https://openrouter.ai)). Остальные ключи — по желанию; в коде есть значения по умолчанию.

### LOG — первая строка (заголовки)

В первую строку листа **LOG**:

```
timestamp | row_id | step | status_before | status_after | duration_ms | cache_hit | error
```

Дальше скрипт сам пишет логи.

---

## 4. Порядок действий при первом запуске

1. Создать таблицу и листы **INPUT**, **OUT**, **SETTINGS**, **LOG** (заголовки — как выше).
2. Заполнить **SETTINGS**: минимум **OPENROUTER_API_KEY** и при необходимости модели/версии промптов.
3. Открыть **Расширения** → **Apps Script**, добавить все **4 файла .gs** и **1 файл .html** (CopyHtmlDialog.html), вставить код из репозитория.
4. Сохранить проект (Ctrl+S). При первом запуске меню нужно **разрешить доступ**: запустить любую функцию (например через меню) и подтвердить разрешения для таблицы.
5. Вернуться в таблицу и обновить страницу (F5). В меню должно появиться **Avito AI**; лист **CONTROL** создастся сам.
6. На **INPUT** заполнить хотя бы одну строку: id, product, city, source_text, mode (например FULL). Выделить эту строку (или несколько), в меню выбрать **Avito AI** → **Сгенерировать (выделенные)** или **Сгенерировать (очередь 50)**.

После этого генерация, экспорт и пакетные операции (Без ИИ и т.д.) будут работать.

---

## 5. Краткая сводка: файлы и листы

- **Залить в Apps Script:**  
  `main.gs`, `utils.gs`, `prompts.gs`, `openrouter.gs`, **CopyHtmlDialog.html** (имя файла в проекте — именно `CopyHtmlDialog`).
- **В таблице:**  
  Листы **INPUT**, **OUT**, **SETTINGS**, **LOG** с заголовками как выше; **SETTINGS** с ключом **OPENROUTER_API_KEY** и при необходимости остальными настройками.
- **Проверка:**  
  Обновить таблицу → меню **Avito AI** → подменю **Без ИИ** (Экспорт, Копировать HTML, Очистить выходы, Сбросить в NEW, Поставить в QUEUED, Пометить DONE) и пункты генерации должны быть доступны и работать.

Если что-то не появляется или падает с ошибкой — проверьте: имя HTML-файла в проекте, наличие листа SETTINGS и ключа OPENROUTER_API_KEY, заголовки INPUT/OUT/LOG в первой строке.
