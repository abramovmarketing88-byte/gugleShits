# Audience Analysis — дополнение для Google Таблиц

JTBD-анализ аудитории через OpenRouter API. Заполняете колонки A–E, запускаете анализ — ИИ предлагает **несколько сегментов ЦА** (3–5 или все релевантные: три — три, пять — пять). Каждый сегмент — **отдельная строка** с полным анализом в F–K.

---

## 1. Установка скрипта

1. Откройте нужную Google Таблицу.
2. **Расширения** → **Apps Script**.
3. Удалите содержимое `Code.gs` и вставьте код из файла **`Code.gs`** этого проекта.
4. В проекте Apps Script создайте файл **HTML**: **+** → **HTML** → имя `Sidebar`. Вставьте содержимое **`Sidebar.html`**.
5. Сохраните проект (Ctrl+S). При первом сохранении дайте проекту имя (например, `Audience Analysis`).
6. **Не подключайте библиотеки.** Всё нужное — в `Code.gs` и `Sidebar.html`. Так дополнение работает из **любого аккаунта** (таблица скопирована / открыта под другим пользователем) без ошибок доступа.

---

## 2. Настройка API (OpenRouter)

1. Получите API-ключ на [openrouter.ai](https://openrouter.ai) (Keys).
2. В Google Таблице откройте меню **Audience Analysis** → **Setup API Key & Model**.
3. Вставьте API-ключ, выберите модель (например, `anthropic/claude-3.5-sonnet`), нажмите **Save Settings**.
4. Ключ хранится в `PropertiesService` (user properties), в коде его нет.

---

## 3. Как пользоваться

1. В первой строке должны быть заголовки. Скрипт создаёт их сам при первом запуске (**Run JTBD Analysis**). Колонки **A–E** (ввод) выделяются голубым, **F–K** (вывод) — зелёным; в ячейках A1–E1 есть примечания с подсказками. Перед записью скрипт разъединяет и очищает ячейки **F–P** (в т.ч. правее K), чтобы слияния не давали «много одинаковых» ячеек (K=L=M=…), затем пишет результат только в F–K. При необходимости: **Audience Analysis** → **Выделить колонки и подсказки**.
2. Заполните **колонки A–E** хотя бы в одной строке (со 2-й):
   - **A** — Продукт  
   - **B** — Контекст / ниша (например, «бухучёт для малого бизнеса»). Можно оставить пустым — **сегменты ЦА предложит ИИ** в колонке F. Для повторного прогона: вставьте сегмент из F в B → снова запустите анализ.  
   - **C** — Желаемый результат  
   - **D** — Болевые точки  
   - **E** — Текущие альтернативы  
3. Выделите нужные строки (или одну ячейку в строке с данными).
4. **Audience Analysis** → **Run JTBD Analysis**.
5. Результат: **одна строка ввода (A–E) → несколько строк вывода.** ИИ генерирует несколько сегментов ЦА (3–5 или все подходящие). Под каждый сегмент создаётся **отдельная строка** с полным анализом в **F–K** (A–E копируются из исходной строки):
   - **F** — Сегмент ЦА (малый/средний бизнес, бухгалтеры которые обжигались, ИП с 1–3 компаниями и т.п.)  
   - **G** — Главная задача (Main Job)  
   - **H** — Эмоциональные и социальные задачи  
   - **I** — Силы прогресса (Push & Pull)  
   - **J** — Силы сдерживания (Anxiety & Inertia)  
   - **K** — Уникальное ценностное предложение (UVP)  

**Повторный прогон (углубление по сегментам):** скопируйте сегменты из **F** в **B**, по одному на строку. Заполните **A**, при необходимости C–E → **Run JTBD Analysis**. ИИ разложит каждый сегмент на боли, Main Job, силы прогресса/сдерживания, UVP.

---

## 4. Разрешения при первом запуске

При первом запуске **Run JTBD Analysis** или **Setup API Key & Model** Google запросит разрешения:

1. Нажмите **Проверить разрешения** → выберите ваш аккаунт.
2. **Дополнение не проверено** → **Перейти к проекту (небезопасно)**.  
   Это ваш собственный скрипт, не стороннее приложение.
3. **Разрешить** доступ.

---

## 5. Авторизация скрипта при открытии таблицы

Если меню **Audience Analysis** не появляется:

1. **Расширения** → **Apps Script**.
2. Выберите функцию `onOpen` в списке, нажмите **Выполнить**.
3. Подтвердите разрешения, если запросит.
4. Вернитесь в таблицу и обновите страницу (F5). Меню должно появиться.

---

## 6. Устранение неполадок

| Ситуация | Что делать |
|----------|------------|
| **OpenRouter API key is not set** | Audience Analysis → Setup API Key & Model, введите ключ и сохраните. |
| **OpenRouter API error (401)** | Неверный или отозванный ключ. Проверьте ключ на openrouter.ai, при необходимости создайте новый. |
| **OpenRouter API error (429)** | Лимиты. Подождите или смените модель. |
| **Количество строк в массиве не соответствует диапазону** | Скрипт разъединяет и очищает F–P перед записью. Если ошибка остаётся — вручную отмените объединение ячеек в F–P для обрабатываемых строк. |
| **В нескольких столбцах (в т.ч. K, L, M…) один и тот же текст** | Часто из-за слияния ячеек **за пределом K** (например K4:P4): значение в K «расползается». Скрипт теперь разъединяет и очищает **F–P** перед записью, затем пишет только в F–K. Обновите `Code.gs`, перезапустите анализ. Если осталось — вручную отмените слияние в строках с данными (F–P). |
| **Не видно сегментов ЦА в F (малый/средний бизнес, бухгалтеры обжигались и т.д.)** | Сегменты ЦА **генерирует ИИ** — это вывод, не ввод. Усильте в `JTBD_SYSTEM_PROMPT` / `JTBD_USER_TEMPLATE` в `Code.gs` формулировки про тип + роль + характеристику. |
| **Только один сегмент вместо нескольких (3–5)** | ИИ должен выводить несколько сегментов и разделять их строкой `---SEGMENT---`. Проверьте промпты в `Code.gs` (`JTBD_SYSTEM_PROMPT`, `JTBD_USER_TEMPLATE`): должно быть явно «3–5 или все релевантные», «между сегментами — ---SEGMENT---». |
| **«Библиотека с идентификатором JtbdPrompts отсутствует»** | Дополнение **не использует** библиотеки. Удалите JtbdPrompts из проекта: **Библиотеки** → выберите **JtbdPrompts** → справа **⋮** → **Удалить** → сохраните. Промпты встроены в `Code.gs`, скрипт будет работать. |
| **Нет строк для анализа** | Выделите строки 2 и ниже с заполненными A–E. Хотя бы в одной ячейке строки должно быть непустое значение. |

---

## 7. Связка с универсальным промптом (JTBD_Авито_Услуги.md)

Структура JTBD в дополнении совпадает с универсальным промптом из **`JTBD_Авито_Услуги.md`**:

- Ввод: A–E (продукт, контекст, результат, боли, альтернативы).  
- Вывод: F–K (Сегмент ЦА, Main Job, эмоц./соц. задачи, силы прогресса, силы сдерживания, UVP).

Промпты заданы **только в `Code.gs`** (константы `JTBD_SYSTEM_PROMPT`, `JTBD_USER_TEMPLATE`). Внешние библиотеки не используются — так всё работает одинаково из любого аккаунта. Чтобы изменить промпты, правийте `Code.gs`.

---

## 8. Библиотека промптов (не используется)

Дополнение **работает без библиотек**. Промпты встроены в `Code.gs`. Файл **`JtbdPromptsLibrary.gs`** — справочный: если захотите вынести промпты в отдельный проект Apps Script и подключать его как библиотеку, используйте его как шаблон. Учтите: библиотека привязана к аккаунту, который ей владеет; с другого аккаунта она может быть недоступна. Для работы «из любого аккаунта» оставляйте только `Code.gs` + `Sidebar.html`, без библиотек.

---

## Файлы проекта

- **`Code.gs`** — логика меню, сохранение настроек, вызов OpenRouter, промпты JTBD, парсинг ответа, запись в F–K. Перед записью: разъединение и очистка F–P (чтобы не было дублей в K–P). Внешние библиотеки не используются.  
- **`Sidebar.html`** — форма ввода API-ключа и выбора модели.  
- **`JtbdPromptsLibrary.gs`** — справочный шаблон промптов (для опционального выноса в библиотеку; по умолчанию не используется).  
- **`JTBD_Авито_Услуги.md`** — универсальный JTBD-промт для Cursor и описание подключения к таблицам.
