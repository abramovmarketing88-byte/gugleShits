# Audience Analysis — итоговая инструкция (с нуля)

Один проект Google Apps Script: меню **Audience Analysis**, настройка OpenRouter в сайдбаре, **Run JTBD Analysis** по данным таблицы. Всё работает из трёх файлов в одном проекте.

---

## Какие файлы из папки куда загружать

В папке **gugleShits** лежат файлы **двух разных дополнений**. В один проект Apps Script загружаете только файлы **одного** дополнения.

| Файл в папке | Куда загружать |
|--------------|----------------|
| **Code.gs** | Проект **Audience Analysis** (меню JTBD + сайдбар OpenRouter) |
| **Sidebar.html** | Тот же проект Audience Analysis |
| **JtbdPromptsLibrary.gs** | Тот же проект Audience Analysis |
| **main.gs**, **utils.gs**, **prompts.gs**, **openrouter.gs**, **CopyHtmlDialog.html** | Другой проект — **Avito AI** (генерация объявлений). Инструкция: **DEPLOY.md** |
| **README.md**, **DEPLOY.md**, **AUDIENCE_ANALYSIS_ИНСТРУКЦИЯ.md** | Никуда не загружать — это инструкции, их читают на компьютере |

**Итого:** для **Audience Analysis** в Apps Script нужны только **3 файла**: Code.gs, Sidebar.html, JtbdPromptsLibrary.gs. Остальные .gs и .html — для Avito AI или просто текст инструкций.

---

## Что нужно в проекте Apps Script (3 файла)

В **одной** Google Таблице: **Расширения** → **Apps Script**. В проекте должны быть **ровно эти файлы** (лишние старые можно удалить):

| Файл в проекте   | Откуда взять код |
|------------------|------------------|
| **Code.gs**      | Полностью скопировать из файла `Code.gs` этого репозитория |
| **Sidebar.html** | Полностью скопировать из файла `Sidebar.html` этого репозитория |
| **JtbdPromptsLibrary.gs** | Полностью скопировать из файла `JtbdPromptsLibrary.gs` этого репозитория |

**Библиотеки подключать не нужно.** Все три файла лежат в одном проекте, не как библиотека.

---

## Пошагово: с нуля

### Шаг 1. Открыть Apps Script

1. Откройте вашу Google Таблицу (например «Запуск Авито»).
2. Меню **Расширения** → **Apps Script**.
3. Откроется редактор скриптов (по умолчанию один файл `Code.gs`).

### Шаг 2. Очистить проект и добавить три файла

1. **Code.gs**  
   В левой панели откройте `Code.gs`. Выделите весь код (Ctrl+A), удалите. Откройте файл **Code.gs** из этого репозитория, скопируйте **весь** код и вставьте в редактор. Сохраните (Ctrl+S).

2. **Sidebar.html**  
   В левой панели нажмите **+** → **HTML**. Вместо имени по умолчанию введите **Sidebar** (без .html). Удалите весь шаблонный код, вставьте содержимое файла **Sidebar.html** из репозитория. Сохраните.

3. **JtbdPromptsLibrary.gs**  
   Снова **+** → **Скрипт**. Имя: **JtbdPromptsLibrary**. Вставьте весь код из **JtbdPromptsLibrary.gs** репозитория. Сохраните.

В итоге в проекте три файла: **Code**, **Sidebar**, **JtbdPromptsLibrary**. Старые файлы (например второй Code или лишние HTML) можно удалить правой кнопкой → Удалить.

### Шаг 3. Сохранить и дать разрешения

1. Сохраните проект (Ctrl+S). При первом сохранении задайте имя проекта (например «Audience Analysis»).
2. Закройте вкладку Apps Script и снова откройте таблицу (или обновите страницу F5).
3. В таблице появится меню **Audience Analysis**. При первом запуске любого пункта меню браузер запросит разрешения — нажмите «Проверить» и разрешите доступ.

### Шаг 4. Настроить API ключ OpenRouter

1. В таблице: **Audience Analysis** → **Setup API Key & Model**.
2. Справа откроется сайдбар «OpenRouter Settings».
3. Вставьте API ключ (получить на [openrouter.ai/keys](https://openrouter.ai/keys)).
4. Выберите модель (например `anthropic/claude-3.5-sonnet`).
5. Нажмите **Save Settings**. Должно появиться сообщение «Настройки сохранены.»

### Шаг 5. Подготовить лист для JTBD

На любом листе таблицы:

- **Строка 1 (заголовки):** можно подписать колонки, например:  
  **A** — Продукт, **B** — Сегмент/контекст, **C** — Желаемый результат, **D** — Боли, **E** — Альтернативы, **F–K** — результаты анализа (появятся после запуска).
- **Со 2-й строки** — данные: заполняйте хотя бы колонки **A–E** для тех строк, по которым нужен JTBD-анализ.

Опционально: **Audience Analysis** → **Выделить колонки и подсказки** — подсветит первую строку и напомнит про A–K.

### Шаг 6. Запустить JTBD Analysis

1. Выделите **одну строку** с данными (или диапазон строк) — именно те строки, по которым нужен анализ.
2. Меню **Audience Analysis** → **Run JTBD Analysis**.
3. Скрипт отправит данные из A–E в OpenRouter, разберёт ответ по разделам и запишет результат в колонки **F–K** той же строки (строк). Внизу появится уведомление «JTBD Analysis выполнен».

Если появится сообщение «Сначала откройте Setup API Key & Model и сохраните API ключ» — вернитесь к шагу 4 и сохраните ключ в сайдбаре.

---

## Что входит в файлы

- **Code.gs** — меню, открытие сайдбара, сохранение/чтение ключа и модели, **runJtbdAnalysis** (чтение A–E, вызов OpenRouter, разбор ответа по ### и запись в F–K), выделение заголовков.
- **Sidebar.html** — форма: поле API ключа, выбор модели, кнопка Save Settings.
- **JtbdPromptsLibrary.gs** — только тексты промптов (системный и пользовательский) и названия разделов для колонок F–K. Логика запуска — в Code.gs.

---

## Если что-то не работает

| Проблема | Что проверить |
|----------|----------------|
| Нет меню «Audience Analysis» | Обновите страницу таблицы (F5). Убедитесь, что в проекте есть Code.gs с функцией `onOpen()`. |
| В сайдбаре нет поля для ключа / кнопка не сохраняет | В проекте должен быть файл **Sidebar** (HTML) с полем `id="apiKey"` и кнопкой. В Code.gs должны быть функции `getStoredApiSettings` и `saveApiSettings`. |
| «JTBD Analysis пока не подключён» или анализ не запускается | В проекте должен быть файл **JtbdPromptsLibrary** с переменными `JTBD_SYSTEM_PROMPT`, `JTBD_USER_TEMPLATE`, `JTBD_SECTION_KEYS`. Функция `runJtbdAnalysis()` находится в **Code.gs** — отдельно добавлять её не нужно. |
| Ошибка при вызове API | Проверьте ключ в Setup API Key & Model и что выбранная модель доступна на OpenRouter. |

После выполнения шагов 1–6 всё должно работать: меню, сайдбар с сохранением ключа и **Run JTBD Analysis** с записью результата в F–K.
